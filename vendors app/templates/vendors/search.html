{% extends 'vendors/base_vendor.html' %}
{% load static %}

{% block vendor_title %}Search Vendors{% endblock %}

{% block vendor_header_title %}Search Vendors{% endblock %}
{% block vendor_header_subtitle %}Find vendors using advanced search criteria{% endblock %}

{% block vendor_breadcrumb_items %}
    <li class="breadcrumb-item active">Search</li>
{% endblock %}

{% block vendor_content %}
    <!-- Search Form Card -->
    <div class="card vendor-card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-search me-2"></i>
                Advanced Search
            </h5>
        </div>
        <div class="card-body">
            {% include 'vendors/_vendor_filters.html' %}
        </div>
    </div>

    <!-- Search Results Summary -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0">
                {% if vendors %}
                    {{ page_obj.paginator.count }} vendor{{ page_obj.paginator.count|pluralize }} found
                {% else %}
                    No vendors found
                {% endif %}
            </h4>
            {% if search_form.search.value %}
                <small class="text-muted">
                    Search results for "<strong>{{ search_form.search.value }}</strong>"
                </small>
            {% elif search_form.is_bound %}
                <small class="text-muted">
                    Filtered results
                </small>
            {% endif %}
        </div>
        
        <div class="d-flex gap-2">
            {% if vendors %}
                <!-- View Options -->
                <div class="btn-group" role="group" aria-label="View options">
                    <input type="radio" class="btn-check" name="view" id="cardView" autocomplete="off" checked>
                    <label class="btn btn-outline-secondary" for="cardView" title="Card View">
                        <i class="bi bi-grid-3x2"></i>
                    </label>

                    <input type="radio" class="btn-check" name="view" id="listView" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="listView" title="List View">
                        <i class="bi bi-list"></i>
                    </label>

                    <input type="radio" class="btn-check" name="view" id="tableView" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="tableView" title="Table View">
                        <i class="bi bi-table"></i>
                    </label>
                </div>
                
                <!-- Export Options -->
                <div class="dropdown">
                    <button class="btn btn-vendor-secondary dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-download me-1"></i>
                        Export
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="{% url 'vendors:export_csv' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">
                                <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                                Export Search Results (CSV)
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'vendors:export_contacts' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">
                                <i class="bi bi-person-lines-fill me-2"></i>
                                Export Contact List
                            </a>
                        </li>
                    </ul>
                </div>
            {% endif %}
            
            {% if perms.vendors.add_vendor %}
                <a href="{% url 'vendors:create' %}" class="btn btn-vendor-primary">
                    <i class="bi bi-plus-circle me-1"></i>
                    Add Vendor
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Search Results -->
    {% if vendors %}
        <!-- Card View (Default) -->
        <div id="cardViewContainer" class="search-results-container">
            {% for vendor in vendors %}
                {% include 'vendors/_vendor_card.html' %}
            {% endfor %}
        </div>

        <!-- List View (Compact) -->
        <div id="listViewContainer" class="search-results-container d-none">
            <div class="list-group">
                {% for vendor in vendors %}
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="vendor-type-icon vendor-type-{{ vendor.vendor_type|lower }} me-3">
                                    <i class="{{ vendor.get_vendor_type_display_icon }}"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">
                                        <a href="{% url 'vendors:detail' vendor.pk %}" class="text-decoration-none">
                                            {{ vendor.name }}
                                        </a>
                                    </h6>
                                    <p class="mb-1 small text-muted">
                                        {{ vendor.vendor_code }} • {{ vendor.contact_person }}
                                        {% if vendor.phone_primary %}• {{ vendor.phone_primary }}{% endif %}
                                    </p>
                                    <small class="text-muted">{{ vendor.city }}, {{ vendor.country }}</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="vendor-badge {% if vendor.status == 'ACTIVE' %}active{% elif vendor.status == 'INACTIVE' %}inactive{% elif vendor.status == 'SUSPENDED' %}suspended{% elif vendor.status == 'BLACKLISTED' %}blacklisted{% endif %}">
                                    {{ vendor.get_status_display }}
                                </span>
                                {% if vendor.is_preferred %}
                                    <span class="vendor-badge preferred d-block mt-1">
                                        <i class="bi bi-star-fill me-1"></i>
                                        Preferred
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Table View (Detailed) -->
        <div id="tableViewContainer" class="search-results-container d-none">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Contact</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Rating</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vendor in vendors %}
                            <tr>
                                <td>
                                    <code>{{ vendor.vendor_code }}</code>
                                </td>
                                <td>
                                    <a href="{% url 'vendors:detail' vendor.pk %}" class="text-decoration-none fw-medium">
                                        {{ vendor.name }}
                                    </a>
                                    {% if vendor.trade_name %}
                                        <br><small class="text-muted">T/A: {{ vendor.trade_name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="vendor-type-icon vendor-type-{{ vendor.vendor_type|lower }} me-2" style="width: 1.5rem; height: 1.5rem;">
                                            <i class="{{ vendor.get_vendor_type_display_icon }}" style="font-size: 0.75rem;"></i>
                                        </div>
                                        <small>{{ vendor.get_vendor_type_display }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div>{{ vendor.contact_person }}</div>
                                    <small class="text-muted">
                                        <a href="tel:{{ vendor.phone_primary }}" class="text-decoration-none">{{ vendor.phone_primary }}</a>
                                    </small>
                                </td>
                                <td>
                                    <small>{{ vendor.city }}</small>
                                    {% if vendor.country != 'Bangladesh' %}
                                        <br><small class="text-muted">{{ vendor.country }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="vendor-badge {% if vendor.status == 'ACTIVE' %}active{% elif vendor.status == 'INACTIVE' %}inactive{% elif vendor.status == 'SUSPENDED' %}suspended{% elif vendor.status == 'BLACKLISTED' %}blacklisted{% endif %}">
                                        {{ vendor.get_status_display }}
                                    </span>
                                    {% if vendor.is_preferred %}
                                        <br><span class="vendor-badge preferred mt-1">
                                            <i class="bi bi-star-fill me-1"></i>
                                            Preferred
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if vendor.performance_rating %}
                                        <div class="performance-stars">
                                            {% with rating=vendor.performance_rating|floatformat:1 %}
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= rating|floatformat:0 %}
                                                        <i class="bi bi-star-fill"></i>
                                                    {% elif forloop.counter <= rating|add:0.5 %}
                                                        <i class="bi bi-star-half"></i>
                                                    {% else %}
                                                        <i class="bi bi-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endwith %}
                                        </div>
                                    {% else %}
                                        <small class="text-muted">Not rated</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="{% url 'vendors:detail' vendor.pk %}">
                                                    <i class="bi bi-eye me-2"></i>View
                                                </a>
                                            </li>
                                            {% if perms.vendors.change_vendor %}
                                                <li>
                                                    <a class="dropdown-item" href="{% url 'vendors:edit' vendor.pk %}">
                                                        <i class="bi bi-pencil me-2"></i>Edit
                                                    </a>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
            <nav aria-label="Search results pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page=1">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    {% else %}
        <!-- No Results -->
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="bi bi-search" style="font-size: 4rem; color: #e5e7eb;"></i>
            </div>
            <h4 class="text-muted mb-3">No vendors match your search criteria</h4>
            <p class="text-muted mb-4">
                Try adjusting your search terms or filters to find what you're looking for.
            </p>
            
            <!-- Search Suggestions -->
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Search Tips:</h6>
                            <ul class="list-unstyled mb-0 small text-start">
                                <li class="mb-1">• Use broader search terms</li>
                                <li class="mb-1">• Check for typos in vendor names or codes</li>
                                <li class="mb-1">• Try searching by city or service type</li>
                                <li class="mb-1">• Clear some filters to see more results</li>
                                <li class="mb-1">• Use partial matches (e.g., "Dell" instead of "Dell Technologies")</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-center gap-3 mt-4">
                <a href="{% url 'vendors:search' %}" class="btn btn-vendor-secondary">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Clear Search
                </a>
                <a href="{% url 'vendors:list' %}" class="btn btn-vendor-primary">
                    <i class="bi bi-list me-1"></i>
                    View All Vendors
                </a>
            </div>
        </div>
    {% endif %}

    <!-- Saved Searches (Future Feature) -->
    <div class="card border-0 bg-light mt-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h6 class="mb-1">Quick Search Links</h6>
                    <p class="mb-0 small text-muted">Common vendor searches for Parliament Secretariat</p>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{% url 'vendors:active' %}" class="btn btn-sm btn-outline-success">
                            Active Vendors
                        </a>
                        <a href="{% url 'vendors:preferred' %}" class="btn btn-sm btn-outline-warning">
                            Preferred
                        </a>
                        <a href="{% url 'vendors:suppliers' %}" class="btn btn-sm btn-outline-primary">
                            Suppliers
                        </a>
                        <a href="{% url 'vendors:service_providers' %}" class="btn btn-sm btn-outline-info">
                            Services
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block vendor_extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // View switching functionality
            const cardViewBtn = document.getElementById('cardView');
            const listViewBtn = document.getElementById('listView');
            const tableViewBtn = document.getElementById('tableView');
            
            const cardViewContainer = document.getElementById('cardViewContainer');
            const listViewContainer = document.getElementById('listViewContainer');
            const tableViewContainer = document.getElementById('tableViewContainer');
            
            function switchView(viewType) {
                // Hide all containers
                cardViewContainer.classList.add('d-none');
                listViewContainer.classList.add('d-none');
                tableViewContainer.classList.add('d-none');
                
                // Show selected container
                switch(viewType) {
                    case 'card':
                        cardViewContainer.classList.remove('d-none');
                        break;
                    case 'list':
                        listViewContainer.classList.remove('d-none');
                        break;
                    case 'table':
                        tableViewContainer.classList.remove('d-none');
                        break;
                }
                
                // Store preference
                localStorage.setItem('vendorSearchView', viewType);
            }
            
            if (cardViewBtn) {
                cardViewBtn.addEventListener('change', () => {
                    if (cardViewBtn.checked) switchView('card');
                });
            }
            
            if (listViewBtn) {
                listViewBtn.addEventListener('change', () => {
                    if (listViewBtn.checked) switchView('list');
                });
            }
            
            if (tableViewBtn) {
                tableViewBtn.addEventListener('change', () => {
                    if (tableViewBtn.checked) switchView('table');
                });
            }
            
            // Restore saved view preference
            const savedView = localStorage.getItem('vendorSearchView');
            if (savedView) {
                switch(savedView) {
                    case 'list':
                        if (listViewBtn) {
                            listViewBtn.checked = true;
                            switchView('list');
                        }
                        break;
                    case 'table':
                        if (tableViewBtn) {
                            tableViewBtn.checked = true;
                            switchView('table');
                        }
                        break;
                    default:
                        if (cardViewBtn) {
                            cardViewBtn.checked = true;
                            switchView('card');
                        }
                }
            }
            
            // Search result highlighting
            const searchTerm = '{{ search_form.search.value|escapejs }}';
            if (searchTerm) {
                const results = document.querySelectorAll('.search-results-container');
                results.forEach(container => {
                    highlightText(container, searchTerm);
                });
            }
            
            function highlightText(container, term) {
                if (!term) return;
                
                const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
                const walker = document.createTreeWalker(
                    container,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    if (node.textContent.match(regex)) {
                        textNodes.push(node);
                    }
                }
                
                textNodes.forEach(node => {
                    const highlighted = node.textContent.replace(regex, '<mark class="bg-warning">$1</mark>');
                    if (highlighted !== node.textContent) {
                        const span = document.createElement('span');
                        span.innerHTML = highlighted;
                        node.parentNode.replaceChild(span, node);
                    }
                });
            }
            
            function escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + F to focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    const searchInput = document.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
                
                // Escape to clear search
                if (e.key === 'Escape') {
                    const searchInput = document.querySelector('.search-input');
                    if (searchInput && document.activeElement === searchInput) {
                        searchInput.value = '';
                        searchInput.form.submit();
                    }
                }
            });
        });
    </script>
{% endblock %}